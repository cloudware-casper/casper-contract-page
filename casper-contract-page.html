<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">

<dom-module id="casper-contract-page">
  <template>
    <style>

      :host {
        display: flex;
        flex-direction: column;
        padding: 10px;
        width: 70%;
        max-width: 960px;
        box-sizing: border-box;
        /* word-break: break-all; */
        --paper-spinner-color: var(--primary-color);
        --paper-spinner-stroke-width: 5px;
      }

      .content {
        overflow: auto;
        padding: 0px;
        background-color: white;
      }


      .container-text, .title {
        padding: 20px;
      }

      .container-text {
        padding-bottom: 150px;
      }

      .content .hero img {
        width: 100%;
        display: inline-block;
      }

      ::slotted(hr) {
        display: none;
      }

      ::slotted(b) {
        color: var(--primary-color);
        font-size: 20px;
        font-weight: normal;
      }

      ::slotted(a){
        color: var(--primary-color);;
        text-transform: none;
      }

      ::slotted(a:hover){
        background-color: var(--primary-color);
        color: white;
      }

      paper-button{
        width: 100%;
        text-align: center;
        background-color: var(--primary-color);
        color: white;
        margin: 0px;
        transition: background-color 0.5s;
        /* margin-top: 20px;
        margin-bottom: 20px;
        margin: 120px; */
        /* word-break: break-all; */
      }

      paper-button:hover {
        background: var(--dark-primary-color);;
        transition: background-color 0.5s;
      }

      paper-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
        cursor: auto;
        pointer-events: none;
        transition: background-color 0.5s;
      }

      .button-container {
        padding: 10px 20px 0px 20px;
        position: fixed;
        bottom: 0;
        width: 882px;
      }

      .button-container .inner-container, .button-container .shadow-break{
        margin-left: -20px;
        margin-right: -20px;
      }

      .button-container .inner-container {
        background: #f9f9f9;
        padding: 10px 20px 20px 20px
      }

      .button-container .shadow-break{
        background-image: linear-gradient(-180deg, rgba(238,238,238,0.00) 0%, #f9f9f9 100%);
        border-bottom: 1px #f1f0f0 solid;
        height: 30px;
      }

      .button-container .instructions {
        text-align: center;
        display: inherit;
        margin-bottom: 10px;
        color: gray;
      }

      .button-container .instructions.error {
        display: none;
        color: red;
        font-style: italic;
      }

      .button-container paper-button {
        width: 100%;
      }

      .title {
        font-size: 40px;
        color: var(--primary-color);
        font-family: 'Titan One', cursive;
      }

      /* #spin {
        margin-right: 10px;
      } */

      /* #submitButton .text {
        margin-left: 10px;
      } */

      @media only screen
      and (min-device-width : 320px)
      and (max-device-width : 1024px)
      and (-webkit-min-device-pixel-ratio: 1)  {

        :host {
          width: 100%;
          /* background: green; */
        }


      }
    </style>

    <div class="content">

      <template is="dom-if" if="[[image]]" restamp="true">
        <div class="hero">
          <img src="[[image]]" alt="hero image">
        </div>
      </template>

      <template is="dom-if" if="[[title]]" restamp="true">
        <div class="title">
          [[title]]
        </div>
      </template>
      <div class="container-text">
        <slot></slot>
      </div>
      <div class="button-container" id="action_container">
        <div class="shadow-break"></div>
        <div class="inner-container">
          <small id="instructions" class='instructions'>Obrigatório ler as condições até ao fim para aceitar.</small>
          <small id="error_messages" class='instructions error'></small>
          <paper-button id="submitButton" disabled on-tap="_customerAgreement">
            <paper-spinner-lite id="spin"></paper-spinner-lite>
            <span id="submitText" class='text'>Concordo e aceito</span>
          </paper-button>
        </div>
      </div>
    </div>

  </template>

  <script>
    /**
     * `casper-contract-page`
     * A component to acceptance of terms and conditions
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperContract extends Polymer.Element {
      static get is() { return 'casper-contract-page'; }
      static get properties() {
        return {
          xhrUrl: {
            type: String,
            value: '/jobs'
          },
          jwtParam: {
            type: String,
            value: 'jwt'
          },
          title: {
            type: Object
          },
          image: {
            type: Object
          }
        };
      }

      static getParams (url) {
         var regex = /[?&]([^=#]+)=([^&#]*)/g,
             params = {},
             match;
         while(match = regex.exec(url)) {
             params[match[1]] = match[2];
         }
         return params;
      }

      ready () {
        super.ready();
        this._params = CasperContract.getParams(window.location.href);
        window.onscroll = function(ev) {
           if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
              this.$.submitButton.disabled = false;
           }
        }.bind(this);

        this._adjustButton();

        window.onresize = function(){
          this._adjustButton();
        }.bind(this);

        if(this._params[this.jwtParam] == undefined){
          this.$.action_container.style.display = 'none';
          this.shadowRoot.querySelector('.container-text').style.paddingBottom = '20px';
        }

        this.style.opacity = 1;
      }

      _errorMessage (msg) {
        this.$.instructions.style.display   = 'none';
        this.$.error_messages.innerText = msg;
        this.$.error_messages.style.display = 'block';
      }

      _adjustButton () {
        var text   = this.shadowRoot.querySelector('.container-text');
        var button = this.shadowRoot.querySelector('.button-container');
        button.style.width = text.getBoundingClientRect().width - 40 + 'px';
      }

      _submittingState (state) {
        switch (state) {
          case true:
            this.$.submitButton.disabled = true;
            this.$.spin.active = true;
            this.$.submitText.style.display = 'none';
            break;
          case false:
            this.$.spin.active = false;
            this.$.submitText.style.display = 'inline-block';
            this.$.submitButton.disabled = false;
            break;
          default:

        }
      }

      _customerAgreement (event) {
        this._submittingState(true);

        var xhr = new XMLHttpRequest();
        var response = null;
    		xhr.open("POST", this.xhrUrl, true);
    		xhr.setRequestHeader("Content-type", "application/text");
    		xhr.setRequestHeader("Accept",       "application/json");
    		xhr.timeout = 10000;

        xhr.onreadystatechange = function() {
          if (xhr.readyState == XMLHttpRequest.DONE) {
            switch (xhr.status) {
              case 200:
                window.location = JSON.parse(xhr.response).redirect_to;
                break;
              case 500:
                this._submittingState(false)
                this._errorMessage(JSON.parse(xhr.response).message);
                break;
              default:
                this._submittingState(false)
                this._errorMessage('Alguma coisa correu mal, por favor tente novamente.');
            }
    		  }
    		}.bind(this)

        xhr.send(this._params[this.jwtParam]);
      }
    }

    window.customElements.define(CasperContract.is, CasperContract);
  </script>
</dom-module>
