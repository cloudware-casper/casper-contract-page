<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-button/casper-button.html">

<dom-module id="casper-contract-page">
  <template>
    <style>

      :host {
        display: flex;
        flex-direction: column;
        padding: 10px;
        width: 70%;
        max-width: 960px;
        box-sizing: border-box;
        /* word-break: break-all; */
        --paper-spinner-color: var(--primary-color);
        --paper-spinner-stroke-width: 5px;
        /* background-color: red; */
      }

      :host(.iframe) {
        width: 100%;
      }

      .content {
        overflow: auto;
        padding: 0px;
        background-color: white;
      }


      .title {
        padding: 20px 20px 0 20px;
      }

      .container-text {
        padding: 0 20px 100px 20px;
        /* background-color: yellow; */
        box-sizing: border-box;
      }

      @media screen and (-ms-high-contrast: active), screen and (-ms-high-contrast: none) {
        .container-text {
          padding: 0 20px 60px 20px;
          /* background-color: red; */
          box-sizing: border-box;
        }
      }

      .content .hero img {
        width: 100%;
        display: inline-block;
      }

      .button-container {
        padding: 10px 20px 0px 20px;
        position: fixed;
        bottom: 0;
        width: 882px;
      }

      .button-container .inner-container, .button-container .shadow-break{
        margin-left: -20px;
        margin-right: -20px;
      }

      .button-container .inner-container {
        background: #f9f9f9;
        padding: 10px 20px 20px 20px
      }

      .button-container .shadow-break{
        background-image: linear-gradient(-180deg, rgba(238,238,238,0.00) 0%, #f9f9f9 100%);
        border-bottom: 1px #f1f0f0 solid;
        height: 30px;
      }

      .button-container .instructions {
        text-align: center;
        display: inherit;
        margin-bottom: 10px;
        color: gray;
      }

      .button-container .instructions.success {
        color: green;
        font-style: italic;
      }

      .button-container .instructions.error {
        display: none;
        color: red;
        font-style: italic;
      }

      .button-container paper-button {
        width: 100%;
      }

      .title {
        font-size: 30px;
        color: var(--primary-color);
        font-family: 'Titan One', cursive;
      }


      .buttons {
        display: flex;
      }

      .buttons casper-button {
        width: 100%;
      }

      .buttons casper-button:first-child {
        margin-left: 0px;
      }

      .buttons casper-button#declineButton {
        margin-right: 10px;
      }

      #declineButton {
        display: none;
      }

      @media only screen
      and (min-device-width : 320px)
      and (max-device-width : 1024px)
      and (-webkit-min-device-pixel-ratio: 1)  {

        :host {
          width: 100%;
        }


      }
    </style>

    <div class="content">

      <template is="dom-if" if="[[image]]" restamp="true">
        <div class="hero">
          <img src="[[image]]" alt="hero image">
        </div>
      </template>

      <template is="dom-if" if="[[title]]" restamp="true">
        <div class="title">
          [[title]]
        </div>
      </template>
      <div class="container-text" id="container_text" name="document">
        <slot name="document"></slot>
      </div>
      <div class="button-container" id="action_container">
        <div class="shadow-break"></div>
        <div class="inner-container">
          <small id="instructions" class='instructions'>
            <slot name="instructions"></slot>
          </small>
          <small id="error_messages" class='instructions error'></small>

          <div class="buttons">
            <casper-button id="declineButton" css_class="decline-button" on-tap="_declineAction">
              <div slot="text-button">
                <slot name="decline-button">NO</slot>
              </div>
            </casper-button>

            <casper-button id="submitButton" on-tap="_customerAgreement">
              <div slot="text-button">
                <slot name="action-button">Concordo e aceito</slot>
              </div>
            </casper-button>
          </div>
        </div>
      </div>
    </div>

  </template>

  <script>
    /**
     * `casper-contract-page`
     * A component to acceptance of terms and conditions
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperContract extends Polymer.Element {
      static get is() { return 'casper-contract-page'; }
      static get properties() {
        return {
          xhrUrl: {
            type: String,
            value: '/jobs'
          },
          jwtParam: {
            type: String,
            value: 'jwt'
          },
          title: {
            type: Object
          },
          image: {
            type: Object
          },
          acceptanceRequired: {
            type: Boolean,
            value: false
          },
          checkboxRequired: {
            type: Boolean,
            value: false
          },
          yesNoRequired: {
            type: Boolean,
            value: false
          }
        };
      }

      static getParams (url) {
         var regex = /[?&]([^=#]+)=([^&#]*)/g,
             params = {},
             match;
         while(match = regex.exec(url)) {
             params[match[1]] = match[2];
         }
         return params;
      }

      static _b64EncodeUnicode (str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
          function toSolidBytes(match, p1) {
            return String.fromCharCode('0x' + p1);
        }));
      }

      ready () {
        super.ready();
        this._params = CasperContract.getParams(window.location.href);

        if(this.yesNoRequired == true) {
          this.$.declineButton.style.display = 'block'
        }

        if(this.acceptanceRequired == true){
          this._buttonState(true, this.$.submitButton);
        }

        if(this.checkboxRequired == false){
          window.onscroll = function(ev) {

            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
              // this.$.submitButton.disabled = false;
              this._buttonState(false, this.$.submitButton);
            }
          }.bind(this);
        }

        this._adjustButton();

        window.onresize = function(){
          this._adjustButton();
        }.bind(this);

        if(this._params[this.jwtParam] == undefined){
          this.$.action_container.style.display = 'none';
          this.shadowRoot.querySelector('.container-text').style.paddingBottom = '20px';
        }

        this.style.opacity = 1;

        if(this.checkboxRequired == true){
          this.$.container_text.addEventListener('click', function (event) {
            if(event.target.parentElement.className == 'checkbox'){
              this._buttonState(!event.target.parentElement.children[0].checked);
            }
          }.bind(this), false);
        }

      }

      _errorMessage (msg) {
        this.$.instructions.classList.remove("success");
        this.$.instructions.style.display   = 'none';
        this.$.error_messages.innerText     = msg;
        this.$.error_messages.style.display = 'block';
      }

      _successMessage (msg) {
        this.$.error_messages.style.display   = 'none';
        this.$.instructions.classList.add("success");
        this.$.instructions.style.display     = 'block';
        this.$.instructions.innerText         = msg;
      }

      _adjustButton () {
        var text   = this.shadowRoot.querySelector('.container-text');
        var button = this.shadowRoot.querySelector('.button-container');
        button.style.width = text.getBoundingClientRect().width - 40 + 'px';
      }

      _buttonState (state, button) {
        // var button_scope = this.shadowRoot.querySelector('casper-button');
        button.disabled = state;
      }
      _submittingState (state, button, event) {
        switch (state) {
          case true:
            // this.$.submitButton.disabled = true;
            this._buttonState(true, button);
            event.currentTarget.$.spin.active = true;
            event.currentTarget.$.submitText.style.display = 'none';
            break;
          case false:
            this.shadowRoot.querySelector('casper-button').$.spin.active = false;
            this.shadowRoot.querySelector('casper-button').$.submitText.style.display = 'inline-block';
            // this.$.submitButton.disabled = false;
            this._buttonState(false, button);
            break;
          default:

        }
      }

      _declineAction (event) {
        this._hideButton(this.$.submitButton);
        this._sendToJob(event, 'decline', this.$.declineButton);
      }

      _customerAgreement (event) {
        this._hideButton(this.$.declineButton);
        this._sendToJob(event, 'accept', this.$.submitButton);
      }

      _hideButton(element) {
        element.style.display = 'none';
      }

      _showButton(element) {
        element.style.display = 'block';
      }

      _sendToJob (event, action, button) {
        this._submittingState(true, button, event);

        var xhr = new XMLHttpRequest();
        var response = null;
        var extra_params = {
          action: action
        };
    		xhr.open("POST", this.xhrUrl, true);
        xhr.setRequestHeader("Content-type",            "application/text");
    		xhr.setRequestHeader("Accept",                  "application/json");
        xhr.setRequestHeader("Casper-Extra-Job-Params", CasperContract._b64EncodeUnicode(JSON.stringify(extra_params)));

        xhr.onprogress = function (event) {
          button.progress = event.loaded;
          // console.log(event.loaded, event.total);
        }.bind(this);

        xhr.onreadystatechange = function() {
          if (xhr.readyState == XMLHttpRequest.DONE) {
            switch (xhr.status) {
              case 200:
                var response_parse = JSON.parse(xhr.response)
                var response_message = response_parse.message || 'resposta com sucesso';

                if(response_parse.redirect_to != undefined) {
                  this._successMessage(response_message);
                  button.progress = 100;
                  setTimeout(function(){
                    window.location = JSON.parse(xhr.response).redirect_to;
                  }, 2000);
                }

                if(response_parse.close_modal != undefined && response_parse.close_modal == true) {
                  this._successMessage(response_message);
                  button.progress = 100;
                  setTimeout(function(){
                    window.parent.dispatchEvent(new CustomEvent('contract_page_close_modal', { detail: { success_contract_page: true } }));
                  }, 2000);
                }

                break;
              case 409, 500:
                this._submittingState(false, button)
                button.progress = 0;
                this._errorMessage(JSON.parse(xhr.response).message);

                setTimeout(function(){
                  window.parent.dispatchEvent(new CustomEvent('contract_page_close_modal', { detail: { success_contract_page: true } }));
                }, 2000);

                break;
              default:
                this._submittingState(false, button)
                button.progress = 0;
                this._errorMessage('Alguma coisa correu mal, por favor tente novamente.');

                setTimeout(function(){
                  window.parent.dispatchEvent(new CustomEvent('contract_page_close_modal', { detail: { success_contract_page: true } }));
                }, 2000);
            }
    		  }
    		}.bind(this);

        xhr.send(this._params[this.jwtParam]);
      }
    }

    window.customElements.define(CasperContract.is, CasperContract);
  </script>
</dom-module>
